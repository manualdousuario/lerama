#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../vendor/autoload.php';

use League\CLImate\CLImate;
use Lerama\Commands\FeedProcessor;
use Lerama\Commands\FeedImporter;
use Lerama\Services\ProxyService;
use Lerama\Services\EmailService;

$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

DB::$host = $_ENV['LERAMA_DB_HOST'];
DB::$user = $_ENV['LERAMA_DB_USER'];
DB::$password = $_ENV['LERAMA_DB_PASS'];
DB::$dbName = $_ENV['LERAMA_DB_NAME'];
DB::$port = (int)$_ENV['LERAMA_DB_PORT'];
DB::$encoding = 'utf8mb4';

$climate = new CLImate();

$processor = new FeedProcessor($climate);

$command = $argv[1] ?? '';

if (empty($command)) {
    showUsage($climate);
    exit(1);
}

switch ($command) {
    case 'feed:process':
        $processor->process();
        break;

    case 'feed:id':
        // Process specific feed by ID
        $feedId = $argv[2] ?? null;

        if (empty($feedId) || !is_numeric($feedId)) {
            $climate->error("Feed ID is required and must be a number");
            exit(1);
        }

        $processor->process((int)$feedId);
        break;
        
    case 'feed:check-status':
        // Check and update status of paused feeds
        $processor->checkPausedFeeds();
        break;

    case 'feed:check-real-content':
        // Check all feed items for real contents
        $processor->checkItemsContent();
        break;

    case 'proxy:update':
        // Update proxy list
        $climate->info("Updating proxy list...");
        $proxyService = new ProxyService();
        if ($proxyService->fetchProxyList()) {
            $climate->green("Proxy list updated successfully");
        } else {
            $climate->red("Failed to update proxy list");
            exit(1);
        }
        break;

    case 'feed:import':
        // Import feeds from CSV
        $csvPath = $argv[2] ?? null;
        
        if (empty($csvPath)) {
            $climate->error("CSV file path is required");
            $climate->out("Usage: php bin/lerama feed:import <path/to/file.csv>");
            exit(1);
        }
        
        $importer = new FeedImporter($climate);
        $importer->import($csvPath);
        break;

    default:
        $climate->error("Unknown command: {$command}");
        showUsage($climate);
        exit(1);
}

function showUsage(CLImate $climate): void
{
    $climate->out("Usage:");
    $climate->out("  php bin/lerama feed:process                    Process all feeds");
    $climate->out("  php bin/lerama feed:id {ID_DO_FEED}            Process a specific feed by ID");
    $climate->out("  php bin/lerama feed:check-status               Check and update status of paused feeds");
    $climate->out("  php bin/lerama feed:check-real-content         Check all feed items for real contents");
    $climate->out("  php bin/lerama feed:import <CSV_FILE>          Import feeds from CSV file (columns: url, tags, category)");
    $climate->out("  php bin/lerama proxy:update                    Update proxy list from PROXY_LIST URL");
    $climate->out("");
    $climate->out("Examples:");
    $climate->out("  php bin/lerama feed:process                    Process all feeds");
    $climate->out("  php bin/lerama feed:import feeds.csv           Import feeds from CSV file");
    $climate->out("  php bin/lerama feed:check-real-content         Check for real content");
}
