#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../vendor/autoload.php';

use League\CLImate\CLImate;
use Lerama\Commands\FeedProcessor;
use Lerama\Commands\FeedImporter;
use Lerama\Services\ProxyService;
use Lerama\Services\EmailService;

$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

DB::$host = $_ENV['LERAMA_DB_HOST'];
DB::$user = $_ENV['LERAMA_DB_USER'];
DB::$password = $_ENV['LERAMA_DB_PASS'];
DB::$dbName = $_ENV['LERAMA_DB_NAME'];
DB::$port = (int)$_ENV['LERAMA_DB_PORT'];
DB::$encoding = 'utf8mb4';

$climate = new CLImate();

$processor = new FeedProcessor($climate);

$command = $argv[1] ?? '';

if (empty($command)) {
    showUsage($climate);
    exit(1);
}

switch ($command) {
    case 'feed:process':
        $parallel = 1;
        
        // Check for --parallel or -p flag
        for ($i = 2; $i < count($argv); $i++) {
            if (in_array($argv[$i], ['--parallel', '-p']) && isset($argv[$i + 1])) {
                $parallel = max(1, min(10, (int)$argv[$i + 1]));
                break;
            }
        }
        
        if ($parallel > 1) {
            $climate->info("Processing feeds with {$parallel} parallel workers");
        }
        
        $processor->process(null, $parallel);
        break;

    case 'feed:id':
        // Process specific feed by ID
        $feedId = $argv[2] ?? null;

        if (empty($feedId) || !is_numeric($feedId)) {
            $climate->error("Feed ID is required and must be a number");
            exit(1);
        }

        $processor->process((int)$feedId, 1);
        break;
        
    case 'feed:check-status':
        // Check and update status of paused feeds
        $processor->checkPausedFeeds();
        break;

    case 'proxy:update':
        // Update proxy list
        $climate->info("Updating proxy list...");
        $proxyService = new ProxyService();
        if ($proxyService->fetchProxyList()) {
            $climate->green("Proxy list updated successfully");
        } else {
            $climate->red("Failed to update proxy list");
            exit(1);
        }
        break;

    case 'db:migrate':
        // Update database to latest version
        $climate->info("Updating database to latest version...");
        $checkDbScript = __DIR__ . '/../../setup/install.php';
        
        if (!file_exists($checkDbScript)) {
            $climate->error("Database migration script not found: {$checkDbScript}");
            exit(1);
        }
        
        // Execute the install.php script
        ob_start();
        require $checkDbScript;
        $output = ob_get_clean();
        
        // Display the output
        $climate->out($output);
        $climate->green("Database migration completed successfully");
        break;

    case 'feed:import':
        // Import feeds from CSV
        $csvPath = $argv[2] ?? null;
        
        if (empty($csvPath)) {
            $climate->error("CSV file path is required");
            $climate->out("Usage: php bin/lerama feed:import <path/to/file.csv>");
            exit(1);
        }
        
        $importer = new FeedImporter($climate);
        $importer->import($csvPath);
        break;

    default:
        $climate->error("Unknown command: {$command}");
        showUsage($climate);
        exit(1);
}

function showUsage(CLImate $climate): void
{
    $climate->out("Usage:");
    $climate->out("  php bin/lerama feed:process [--parallel|-p N]  Process all feeds (optionally with N parallel workers, max 10)");
    $climate->out("  php bin/lerama feed:id {ID_DO_FEED}            Process a specific feed by ID");
    $climate->out("  php bin/lerama feed:check-status               Check and update status of paused feeds");
    $climate->out("  php bin/lerama feed:import <CSV_FILE>          Import feeds from CSV file (columns: url, tags, category)");
    $climate->out("  php bin/lerama proxy:update                    Update proxy list from PROXY_LIST URL");
    $climate->out("  php bin/lerama db:migrate                      Update database to latest version");
    $climate->out("");
    $climate->out("Examples:");
    $climate->out("  php bin/lerama feed:process                    Process all feeds sequentially");
    $climate->out("  php bin/lerama feed:process --parallel 5       Process feeds with 5 parallel workers");
    $climate->out("  php bin/lerama feed:process -p 3               Process feeds with 3 parallel workers");
    $climate->out("  php bin/lerama feed:import feeds.csv           Import feeds from CSV file");
    $climate->out("  php bin/lerama db:migrate                      Update database schema and apply migrations");
}
