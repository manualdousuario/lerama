#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../vendor/autoload.php';

use League\CLImate\CLImate;
use Lerama\Commands\FeedProcessor;
use Lerama\Commands\FeedImporter;
use Lerama\Services\ProxyService;
use Lerama\Services\EmailService;
use Lerama\Services\CacheService;
use Lerama\Services\CacheableQuery;

$dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/..');
$dotenv->load();

DB::$host = $_ENV['LERAMA_DB_HOST'];
DB::$user = $_ENV['LERAMA_DB_USER'];
DB::$password = $_ENV['LERAMA_DB_PASS'];
DB::$dbName = $_ENV['LERAMA_DB_NAME'];
DB::$port = (int)$_ENV['LERAMA_DB_PORT'];
DB::$encoding = 'utf8mb4';

$climate = new CLImate();

$processor = new FeedProcessor($climate);

$command = $argv[1] ?? '';

if (empty($command)) {
    showUsage($climate);
    exit(1);
}

switch ($command) {
    case 'feed:process':
        $processor->process();
        break;

    case 'feed:id':
        // Process specific feed by ID
        $feedId = $argv[2] ?? null;

        if (empty($feedId) || !is_numeric($feedId)) {
            $climate->error("Feed ID is required and must be a number");
            exit(1);
        }

        $processor->process((int)$feedId);
        break;
        
    case 'feed:check-status':
        // Check and update status of paused feeds
        $processor->checkPausedFeeds();
        break;

    case 'feed:check-real-content':
        // Check all feed items for real contents
        $processor->checkItemsContent();
        break;

    case 'proxy:update':
        // Update proxy list
        $climate->info("Updating proxy list...");
        $proxyService = new ProxyService();
        if ($proxyService->fetchProxyList()) {
            $climate->green("Proxy list updated successfully");
        } else {
            $climate->red("Failed to update proxy list");
            exit(1);
        }
        break;

    case 'feed:import':
        // Import feeds from CSV
        $csvPath = $argv[2] ?? null;
        
        if (empty($csvPath)) {
            $climate->error("CSV file path is required");
            $climate->out("Usage: php bin/lerama feed:import <path/to/file.csv>");
            exit(1);
        }
        
        $importer = new FeedImporter($climate);
        $importer->import($csvPath);
        break;

    case 'cache:flush':
        // Flush all cache
        $climate->info("Flushing cache...");
        $cache = CacheService::getInstance();
        if ($cache->flush()) {
            $climate->green("✓ Cache flushed successfully");
        } else {
            $climate->yellow("! Cache flush skipped (Redis may be unavailable)");
        }
        break;

    case 'cache:warm':
        // Warm cache
        $climate->info("Warming cache...");
        $cache = CacheService::getInstance();
        
        if (!$cache->isAvailable()) {
            $climate->red("✗ Redis is not available");
            exit(1);
        }
        
        $climate->out("  Caching categories...");
        $categories = CacheableQuery::query(
            'categories', 'all', ['categories'], 300,
            "SELECT * FROM categories ORDER BY name"
        );
        $climate->green("  ✓ Cached " . count($categories) . " categories");
        
        $climate->out("  Caching tags...");
        $tags = CacheableQuery::query(
            'tags', 'all', ['tags'], 300,
            "SELECT * FROM tags ORDER BY name"
        );
        $climate->green("  ✓ Cached " . count($tags) . " tags");
        
        $climate->out("  Caching feeds dropdown...");
        $feeds = CacheableQuery::query(
            'feeds', 'dropdown', ['feeds'], 300,
            "SELECT id, title FROM feeds ORDER BY title"
        );
        $climate->green("  ✓ Cached " . count($feeds) . " feeds");
        
        $climate->green("✓ Cache warming completed");
        break;

    case 'cache:stats':
        // Cache statistics
        $climate->info("Cache Statistics");
        $cache = CacheService::getInstance();
        $stats = $cache->stats();
        
        if (!$stats['available']) {
            $climate->red("  Redis is not available");
            if (isset($stats['error'])) {
                $climate->red("  Error: " . $stats['error']);
            }
            exit(1);
        }
        
        $climate->out("  Status: <green>Connected</green>");
        $climate->out("  Redis Host: " . ($stats['redis_host'] ?? 'N/A'));
        $climate->out("  Redis Database: " . ($stats['redis_database'] ?? 'N/A'));
        $climate->out("  Connected Clients: " . ($stats['connected_clients'] ?? 'N/A'));
        $climate->out("  Memory Used: " . ($stats['used_memory'] ?? 'N/A'));
        $climate->out("  Total Keys (DB): " . ($stats['total_keys'] ?? 'N/A'));
        $climate->out("  Lerama Keys: " . ($stats['lerama_keys'] ?? 'N/A'));
        $climate->out("  Cache Hits: " . ($stats['hits'] ?? 'N/A'));
        $climate->out("  Cache Misses: " . ($stats['misses'] ?? 'N/A'));
        
        $hits = (int)($stats['hits'] ?? 0);
        $misses = (int)($stats['misses'] ?? 0);
        $total = $hits + $misses;
        if ($total > 0) {
            $hitRate = round(($hits / $total) * 100, 2);
            $climate->out("  Hit Rate: <green>" . $hitRate . "%</green>");
        }
        break;

    case 'cache:invalidate':
        // Invalidate cache tags
        $tag = $argv[2] ?? null;
        
        if (empty($tag)) {
            $climate->error("Tag is required");
            $climate->out("Usage: php bin/lerama cache:invalidate <tag>");
            $climate->out("Available tags: categories, tags, feeds, items");
            exit(1);
        }
        
        $climate->info("Invalidating cache for tag: {$tag}");
        $deleted = CacheableQuery::invalidate($tag);
        $climate->green("✓ Invalidated {$deleted} cache key(s)");
        break;

    default:
        $climate->error("Unknown command: {$command}");
        showUsage($climate);
        exit(1);
}

function showUsage(CLImate $climate): void
{
    $climate->out("Usage:");
    $climate->out("");
    $climate->out("Feed Commands:");
    $climate->out("  php bin/lerama feed:process                    Process all feeds");
    $climate->out("  php bin/lerama feed:id {ID_DO_FEED}            Process a specific feed by ID");
    $climate->out("  php bin/lerama feed:check-status               Check and update status of paused feeds");
    $climate->out("  php bin/lerama feed:check-real-content         Check all feed items for real contents");
    $climate->out("  php bin/lerama feed:import <CSV_FILE>          Import feeds from CSV file (columns: url, tags, category)");
    $climate->out("");
    $climate->out("Cache Commands:");
    $climate->out("  php bin/lerama cache:flush                     Flush all cache");
    $climate->out("  php bin/lerama cache:warm                      Warm cache");
    $climate->out("  php bin/lerama cache:stats                     Cache statistics");
    $climate->out("  php bin/lerama cache:invalidate <tag>          Invalidate cache by tag (categories, tags, feeds, items)");
    $climate->out("");
    $climate->out("Proxy Commands:");
    $climate->out("  php bin/lerama proxy:update                    Update proxy list from PROXY_LIST URL");
    $climate->out("");
    $climate->out("Examples:");
    $climate->out("  php bin/lerama feed:process                    Process all feeds");
    $climate->out("  php bin/lerama feed:import feeds.csv           Import feeds from CSV file");
    $climate->out("  php bin/lerama cache:flush                     Clear all cached data");
    $climate->out("  php bin/lerama cache:stats                     View cache hit/miss statistics");
}
